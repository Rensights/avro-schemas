name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io

jobs:
  validate:
    name: 1️⃣ Validate Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Avro Tools
        run: |
          curl -L https://downloads.apache.org/avro/avro-1.11.3/java/avro-tools-1.11.3.jar -o avro-tools.jar

      - name: Validate Avro Schemas
        run: |
          if [ -d "schemas" ] && [ "$(ls -A schemas/*.avsc 2>/dev/null)" ]; then
            echo "Validating Avro schemas..."
            java -jar avro-tools.jar compile schema schemas/*.avsc /tmp/validate
            echo "✅ All schemas are valid"
          else
            echo "⚠️  No .avsc files found in schemas/ directory"
            echo "Skipping validation (no schemas to validate)"
          fi

  build:
    name: 2️⃣ Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CONTAINER_TOKEN }}

      - name: Set image repository (lowercase)
        id: image-repo
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=${REPO_OWNER}" >> $GITHUB_OUTPUT
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          
          # Determine tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            TAG="latest"
          else
            TAG="develop"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image will be: ghcr.io/${REPO_OWNER}/${REPO_NAME}:${TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:${{ steps.image-repo.outputs.tag }}
            ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:sha-${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=registry,ref=ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:latest
          cache-to: type=inline

      - name: Output image info
        run: |
          echo "✅ Image pushed:"
          echo "   ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:${{ steps.image-repo.outputs.tag }}"
          echo "   ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:sha-${{ github.sha }}"

