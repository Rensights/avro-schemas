name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io

jobs:
  validate:
    name: 1️⃣ Validate Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Avro Tools
        run: |
          echo "Downloading Avro Tools..."
          # Try multiple sources for reliability
          AVRO_VERSION="1.11.3"
          AVRO_URL="https://repo1.maven.org/maven2/org/apache/avro/avro-tools/${AVRO_VERSION}/avro-tools-${AVRO_VERSION}.jar"
          
          # Download with retry and verify
          curl -L --fail --retry 3 --retry-delay 5 "${AVRO_URL}" -o avro-tools.jar || {
            echo "Primary download failed, trying Apache mirror..."
            curl -L --fail --retry 3 --retry-delay 5 "https://downloads.apache.org/avro/avro-${AVRO_VERSION}/java/avro-tools-${AVRO_VERSION}.jar" -o avro-tools.jar
          }
          
          # Verify the JAR file
          if [ ! -f "avro-tools.jar" ]; then
            echo "❌ Error: avro-tools.jar not found after download"
            exit 1
          fi
          
          # Check file size (should be > 1MB)
          FILE_SIZE=$(stat -f%z avro-tools.jar 2>/dev/null || stat -c%s avro-tools.jar 2>/dev/null || echo "0")
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "❌ Error: avro-tools.jar appears to be too small (${FILE_SIZE} bytes), download may have failed"
            cat avro-tools.jar
            exit 1
          fi
          
          # Verify it's a valid JAR by trying to get version
          if ! java -jar avro-tools.jar 2>&1 | head -1 | grep -q "Avro"; then
            echo "⚠️  Warning: Could not verify JAR, but file exists and has size"
          fi
          
          echo "✅ Avro Tools downloaded successfully ($(du -h avro-tools.jar | cut -f1))"

      - name: Validate Avro Schemas
        run: |
          if [ -d "schemas" ] && [ "$(ls -A schemas/*.avsc 2>/dev/null)" ]; then
            echo "Validating Avro schemas..."
            # Create output directory
            mkdir -p /tmp/validate
            
            # Validate each schema file
            for schema in schemas/*.avsc; do
              echo "Validating $(basename $schema)..."
              java -jar avro-tools.jar compile schema "$schema" /tmp/validate || {
                echo "❌ Error: Validation failed for $(basename $schema)"
                exit 1
              }
            done
            
            echo "✅ All schemas are valid"
          else
            echo "⚠️  No .avsc files found in schemas/ directory"
            echo "Skipping validation (no schemas to validate)"
          fi

  build:
    name: 2️⃣ Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CONTAINER_TOKEN }}

      - name: Set image repository (lowercase)
        id: image-repo
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=${REPO_OWNER}" >> $GITHUB_OUTPUT
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          
          # Determine tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            TAG="latest"
          else
            TAG="develop"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image will be: ghcr.io/${REPO_OWNER}/${REPO_NAME}:${TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:${{ steps.image-repo.outputs.tag }}
            ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:sha-${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=registry,ref=ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:latest
          cache-to: type=inline

      - name: Output image info
        run: |
          echo "✅ Image pushed:"
          echo "   ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:${{ steps.image-repo.outputs.tag }}"
          echo "   ghcr.io/${{ steps.image-repo.outputs.repo_owner }}/${{ steps.image-repo.outputs.repo_name }}:sha-${{ github.sha }}"

